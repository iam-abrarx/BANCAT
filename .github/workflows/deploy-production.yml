name: Production Deployment

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    name: Build, Zip, and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql, zip

      # --- FRONTEND ---
      - name: Build Frontend
        run: |
          cd frontend
          echo "VITE_API_URL=https://new.bancat.org.bd/api/v1" > .env.production
          npm install
          npm run build
      
      - name: Zip Frontend
        run: |
          cd frontend/dist
          cp ../../deployment/frontend_htaccess .htaccess
          zip -r ../../frontend.zip .

      # --- ADMIN ---
      - name: Build Admin
        run: |
          cd admin
          echo "VITE_API_URL=https://new.bancat.org.bd/api/v1" > .env.production
          npm install
          npm run build

      - name: Zip Admin
        run: |
          cd admin/dist
          cp ../../deployment/admin_htaccess .htaccess 
          zip -r ../../admin.zip .

      # --- BACKEND ---
      - name: Install Backend Dependencies
        run: |
          cd backend
          composer install --no-dev --optimize-autoloader

      - name: Create .env from Secret
        run: |
          cd backend
          if [ -n "${{ secrets.ENV_FILE }}" ]; then
            echo "${{ secrets.ENV_FILE }}" > .env
          else
            echo "Warning: No ENV_FILE secret found."
            cp .env.example .env
          fi

      - name: Zip Backend (Core)
        run: |
          cd backend
          # Zip contents avoiding .git and node_modules (though composer installed them, we keep them)
          # We exclude storage keys and tests
          zip -r ../backend.zip . -x "*.git*" "tests/*" "storage/*.key" "node_modules/phpunit/*"

      # --- BACKEND PUBLIC ---
      - name: Prepare Public API
        run: |
          cd backend/public
          # Fix paths for production relative to /api/ -> /bancat-api-core/
          sed -i "s|require __DIR__.'/../vendor/autoload.php';|require __DIR__.'/../bancat-api-core/vendor/autoload.php';|g" index.php
          sed -i "s|\$app = require_once __DIR__.'/../bootstrap/app.php';|\$app = require_once __DIR__.'/../bancat-api-core/bootstrap/app.php';|g" index.php
          
          # COPY CUSTOM HTACCESS
          cp ../../deployment/backend_htaccess .htaccess

      - name: Zip Backend Public
        run: |
          cd backend/public
          zip -r ../../backend_public.zip .

      # --- PREPARE ARTIFACTS FOLDER ---
      - name: Collect Artifacts
        run: |
          mkdir deploy_artifacts
          mv frontend.zip deploy_artifacts/
          mv admin.zip deploy_artifacts/
          mv backend.zip deploy_artifacts/
          mv backend_public.zip deploy_artifacts/
          cp deployment/setup_deployment.php deploy_artifacts/
          cp deployment/seed_database.php deploy_artifacts/
          cp deployment/debug_server.php deploy_artifacts/
          cp deployment/check_images.php deploy_artifacts/
          cp deployment/fix_symlink.php deploy_artifacts/

      # --- UPLOAD ---
      - name: Upload Artifacts to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy_artifacts/
          server-dir: ./
          dangerous-clean-slate: false 

      # --- TRIGGER EXTRACTION & MIGRATION ---
      - name: Trigger Deployment Script
        run: |
          echo "Triggering setup script..."
          curl -L "https://new.bancat.org.bd/setup_deployment.php"
          echo "Deployment triggered."
